<!-- Advanced Search Partial -->
<div class="search-container">
    <div class="search-box">
        <input type="text" id="search-input" placeholder="Search content..." autocomplete="off">
        <button type="button" id="search-button" aria-label="Search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        </button>
    </div>
    
    <div id="search-results" class="search-results" style="display: none;">
        <div class="search-results-header">
            <h3>Search Results</h3>
            <button type="button" id="close-search" aria-label="Close search">Ã—</button>
        </div>
        <div id="search-results-content" class="search-results-content"></div>
    </div>
</div>

<style>
.search-container {
    position: relative;
    max-width: 600px;
    margin: 0 auto;
}

.search-box {
    position: relative;
    display: flex;
    align-items: center;
    background: white;
    border: 2px solid #ecf0f1;
    border-radius: 25px;
    padding: 0.5rem 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.search-box:focus-within {
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

#search-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 1rem;
    padding: 0.5rem;
    background: transparent;
}

#search-button {
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
    padding: 0.25rem;
    border-radius: 50%;
    transition: color 0.3s ease;
}

#search-button:hover {
    color: #3498db;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    margin-top: 0.5rem;
    max-height: 400px;
    overflow-y: auto;
}

.search-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #ecf0f1;
    background: #f8f9fa;
}

.search-results-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: #2c3e50;
}

#close-search {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
}

#close-search:hover {
    background: #ecf0f1;
    color: #2c3e50;
}

.search-results-content {
    padding: 0;
}

.search-result-item {
    padding: 1rem;
    border-bottom: 1px solid #ecf0f1;
    transition: background 0.3s ease;
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-item:hover {
    background: #f8f9fa;
}

.search-result-item a {
    text-decoration: none;
    color: inherit;
}

.search-result-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.search-result-excerpt {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 0.5rem;
}

.search-result-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    color: #888;
}

.search-result-type {
    background: #3498db;
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-weight: 500;
}

.search-no-results {
    padding: 2rem;
    text-align: center;
    color: #666;
}

.search-loading {
    padding: 2rem;
    text-align: center;
    color: #666;
}

.search-loading::after {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #ecf0f1;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 0.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .search-container {
        margin: 0 1rem;
    }
    
    .search-results {
        left: -1rem;
        right: -1rem;
    }
}
</style>

<script>
// Search functionality
class SiteSearch {
    constructor() {
        this.searchIndex = [];
        this.searchInput = document.getElementById('search-input');
        this.searchButton = document.getElementById('search-button');
        this.searchResults = document.getElementById('search-results');
        this.searchResultsContent = document.getElementById('search-results-content');
        this.closeSearch = document.getElementById('close-search');
        
        this.init();
    }
    
    init() {
        this.buildSearchIndex();
        this.bindEvents();
    }
    
    buildSearchIndex() {
        // Get all content from the site
        const content = this.getSiteContent();
        this.searchIndex = content.map(item => ({
            ...item,
            searchText: this.normalizeText(item.title + ' ' + item.content + ' ' + (item.tags || []).join(' '))
        }));
    }
    
    getSiteContent() {
        // This would normally fetch from your site's content
        // For now, we'll use a simplified approach
        const content = [];
        
        // Get content from the current page
        const articles = document.querySelectorAll('article, .post-item, .project-card, .testimonial-card');
        articles.forEach(article => {
            const title = article.querySelector('h1, h2, h3, .title')?.textContent || '';
            const content = article.textContent || '';
            const link = article.querySelector('a')?.href || window.location.href;
            const type = this.getContentType(article);
            
            if (title) {
                content.push({
                    title: title.trim(),
                    content: content.trim(),
                    link: link,
                    type: type,
                    excerpt: this.getExcerpt(content, 150)
                });
            }
        });
        
        return content;
    }
    
    getContentType(element) {
        if (element.classList.contains('post-item') || element.closest('.posts')) return 'Post';
        if (element.classList.contains('project-card') || element.closest('.projects')) return 'Project';
        if (element.classList.contains('testimonial-card') || element.closest('.testimonials')) return 'Testimonial';
        return 'Page';
    }
    
    getExcerpt(text, length) {
        return text.length > length ? text.substring(0, length) + '...' : text;
    }
    
    normalizeText(text) {
        return text.toLowerCase()
            .replace(/[^\w\s]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
    }
    
    bindEvents() {
        this.searchInput.addEventListener('input', this.debounce(() => {
            this.performSearch();
        }, 300));
        
        this.searchButton.addEventListener('click', () => {
            this.performSearch();
        });
        
        this.closeSearch.addEventListener('click', () => {
            this.hideResults();
        });
        
        // Close search when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                this.hideResults();
            }
        });
        
        // Handle keyboard navigation
        this.searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.hideResults();
            }
        });
    }
    
    performSearch() {
        const query = this.searchInput.value.trim();
        
        if (query.length < 2) {
            this.hideResults();
            return;
        }
        
        this.showLoading();
        
        setTimeout(() => {
            const results = this.search(query);
            this.displayResults(results, query);
        }, 100);
    }
    
    search(query) {
        const normalizedQuery = this.normalizeText(query);
        const queryWords = normalizedQuery.split(' ');
        
        return this.searchIndex
            .map(item => {
                let score = 0;
                const searchText = item.searchText;
                
                // Exact match gets highest score
                if (searchText.includes(normalizedQuery)) {
                    score += 100;
                }
                
                // Title matches get high score
                if (this.normalizeText(item.title).includes(normalizedQuery)) {
                    score += 50;
                }
                
                // Word matches
                queryWords.forEach(word => {
                    if (searchText.includes(word)) {
                        score += 10;
                    }
                });
                
                return { ...item, score };
            })
            .filter(item => item.score > 0)
            .sort((a, b) => b.score - a.score)
            .slice(0, 10);
    }
    
    displayResults(results, query) {
        if (results.length === 0) {
            this.showNoResults();
            return;
        }
        
        const html = results.map(result => `
            <div class="search-result-item">
                <a href="${result.link}">
                    <div class="search-result-title">${this.highlightText(result.title, query)}</div>
                    <div class="search-result-excerpt">${this.highlightText(result.excerpt, query)}</div>
                    <div class="search-result-meta">
                        <span class="search-result-type">${result.type}</span>
                        <span>${new URL(result.link).pathname}</span>
                    </div>
                </a>
            </div>
        `).join('');
        
        this.searchResultsContent.innerHTML = html;
        this.showResults();
    }
    
    highlightText(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    }
    
    showLoading() {
        this.searchResultsContent.innerHTML = '<div class="search-loading">Searching...</div>';
        this.showResults();
    }
    
    showNoResults() {
        this.searchResultsContent.innerHTML = '<div class="search-no-results">No results found. Try different keywords.</div>';
        this.showResults();
    }
    
    showResults() {
        this.searchResults.style.display = 'block';
    }
    
    hideResults() {
        this.searchResults.style.display = 'none';
    }
    
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}

// Initialize search when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new SiteSearch();
});
</script>
