<!-- Analytics and Monitoring Setup -->
<!-- Google Analytics 4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'GA_MEASUREMENT_ID', {
    // Enhanced measurement
    enhanced_measurement: true,
    
    // Custom parameters
    custom_map: {
      'custom_parameter_1': 'content_type',
      'custom_parameter_2': 'content_category'
    },
    
    // Privacy settings
    anonymize_ip: true,
    allow_google_signals: false,
    allow_ad_personalization_signals: false
  });
  
  // Track page views
  gtag('event', 'page_view', {
    page_title: document.title,
    page_location: window.location.href,
    content_type: '{{ .Type }}',
    content_category: '{{ .Section }}'
  });
  
  // Track search usage
  function trackSearch(query, results) {
    gtag('event', 'search', {
      search_term: query,
      results_count: results
    });
  }
  
  // Track form submissions
  function trackFormSubmission(formType) {
    gtag('event', 'form_submit', {
      form_type: formType,
      event_category: 'engagement'
    });
  }
  
  // Track social sharing
  function trackSocialShare(platform) {
    gtag('event', 'share', {
      method: platform,
      content_type: '{{ .Type }}',
      item_id: '{{ .Permalink }}'
    });
  }
  
  // Track CMS usage
  function trackCMSUsage(action) {
    gtag('event', 'cms_action', {
      action: action,
      event_category: 'cms'
    });
  }
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM_CONTAINER_ID');</script>

<!-- Performance monitoring -->
<script>
  // Core Web Vitals monitoring
  function sendToAnalytics({name, delta, value, id}) {
    gtag('event', name, {
      event_category: 'Web Vitals',
      event_label: id,
      value: Math.round(name === 'CLS' ? delta * 1000 : delta),
      non_interaction: true,
    });
  }
  
  // Measure Core Web Vitals
  if ('web-vital' in window) {
    import('web-vitals').then(({getCLS, getFID, getFCP, getLCP, getTTFB}) => {
      getCLS(sendToAnalytics);
      getFID(sendToAnalytics);
      getFCP(sendToAnalytics);
      getLCP(sendToAnalytics);
      getTTFB(sendToAnalytics);
    });
  }
  
  // Custom performance metrics
  window.addEventListener('load', () => {
    setTimeout(() => {
      const perfData = performance.getEntriesByType('navigation')[0];
      
      gtag('event', 'performance_metrics', {
        dom_content_loaded: Math.round(perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart),
        load_complete: Math.round(perfData.loadEventEnd - perfData.loadEventStart),
        first_paint: Math.round(performance.getEntriesByType('paint').find(entry => entry.name === 'first-paint')?.startTime || 0),
        first_contentful_paint: Math.round(performance.getEntriesByType('paint').find(entry => entry.name === 'first-contentful-paint')?.startTime || 0)
      });
    }, 0);
  });
</script>

<!-- Error tracking -->
<script>
  // Global error handler
  window.addEventListener('error', (event) => {
    gtag('event', 'exception', {
      description: event.error?.message || 'Unknown error',
      fatal: false,
      error_type: 'javascript_error'
    });
  });
  
  // Unhandled promise rejection handler
  window.addEventListener('unhandledrejection', (event) => {
    gtag('event', 'exception', {
      description: event.reason?.message || 'Unhandled promise rejection',
      fatal: false,
      error_type: 'promise_rejection'
    });
  });
</script>

<!-- User engagement tracking -->
<script>
  // Track scroll depth
  let maxScroll = 0;
  window.addEventListener('scroll', () => {
    const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
    if (scrollPercent > maxScroll && scrollPercent % 25 === 0) {
      maxScroll = scrollPercent;
      gtag('event', 'scroll', {
        event_category: 'engagement',
        value: scrollPercent
      });
    }
  });
  
  // Track time on page
  let startTime = Date.now();
  window.addEventListener('beforeunload', () => {
    const timeOnPage = Math.round((Date.now() - startTime) / 1000);
    gtag('event', 'timing_complete', {
      name: 'time_on_page',
      value: timeOnPage
    });
  });
  
  // Track outbound links
  document.addEventListener('click', (event) => {
    const link = event.target.closest('a');
    if (link && link.hostname !== window.location.hostname) {
      gtag('event', 'click', {
        event_category: 'outbound',
        event_label: link.href,
        transport_type: 'beacon'
      });
    }
  });
</script>

<!-- Heatmap tracking (if using Hotjar or similar) -->
<script>
  // Hotjar tracking
  (function(h,o,t,j,a,r){
    h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
    h._hjSettings={hjid:HOTJAR_ID,hjsv:6};
    a=o.getElementsByTagName('head')[0];
    r=o.createElement('script');r.async=1;
    r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
    a.appendChild(r);
  })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>

<!-- Uptime monitoring -->
<script>
  // Simple uptime check
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', (event) => {
      if (event.data.type === 'SW_UPDATE') {
        gtag('event', 'service_worker_update', {
          event_category: 'performance'
        });
      }
    });
  }
</script>
